## <center>GPU 编程实验 2--图采样</center>

| **学号**   | **专业班级** | **姓名** |
| ---------- | ------------ | -------- |
| 3200100574 | 图灵2001     | 宋佳铮   |

## 1.  Project Introduction

本次实验是利用GPU并行实现图神经网络随机采样(sec1)，并优化统计以40个节点为一个bin的总被采样次数的核函数。本次实验运行在RTX8000上。

## 2.  Technical Details

### sec1：

主要实现随机采样函数的并行，最关键的是搞清楚CSR存储格式：

![image-20230520010456064](C:\Users\scuri\AppData\Roaming\Typora\typora-user-images\image-20230520010456064.png)

​																								图1：CSR存储格式

即根据初始节点的ID在下标指针数组（indptr）中找到邻居节点存储地址的起始位置，并以下一个节点的邻居节点存储地址的起始位置为邻居节点的结束位置，获得节点的所有邻居节点ID。

随后就是最基础的多线程跨网格并行代码框架，需要注意的是随机采样时生成的随机数是根据threadIdx.x来的，要么修改随机采样的函数使得其在同一起始点的多次采样结果不同，要么修改线程下标定义：根据每次采样开线程，而不是每个节点开线程。

同时需要注意的是代码复用性，在编号采样节点存储地址时不要采用硬编码，采用函数输入。

### sec2：

主要实现对于超大数组（第一跳目标节点）的信息进行并行统计的函数的优化加速。

原始的函数已经实现了开满线程并行读取目标节点数组，但由于写入的统计数组是一个全局数组，并且需要保证写入操作的原子性，因此在遇到同一个位置需要写入时就退化成了串行。

因此第一个考虑优化的地方是使用中间临时存储数组存储块内统计结果，最后将所有块内的统计数组累加获得最终全局结果。

第二个想法是将输入的d_dst_ids数组在对应块需要索引的数据读入块内共享内存，但是仔细思考发现就算读入每个block的共享内存也至少需要block内的每个线程读一次，由于读取的顺序性以及一次读取的不是一个int，这反而会影响预取缓存的命中率，因此这个优化其实没有什么意义甚至是负优化。基于相同的原因交错寻址没能实现优化。





## 3.  Experiment Results

### sec1

![sec1](E:\AI-chips\gpu\GPU_code\sec1.png)

<center>图2：前20个随机采样点ID</center>

![sec1_time](E:\AI-chips\gpu\GPU_code\sec1_time.png)

<center>图3：采样 GPU 核函数执行时间</center>

### sec2

![sec2_base](E:\AI-chips\gpu\GPU_code\sec2_base.png)

<center>图4：base版本核函数执行时间</center>

![sec2_opt](E:\AI-chips\gpu\GPU_code\sec2_opt.png)

<center>图5：优化后核函数执行时间</center>

采样方式不同（每个线程采样一次还是采样多次），最终时间也不一致，上面是每个线程采样多次的结果。

![sec2_sbase](E:\AI-chips\gpu\GPU_code\sec2_sbase.png)

![sec2_sopt](E:\AI-chips\gpu\GPU_code\sec2_sopt.png)

<center>图6-7：base版本核函数执行时间和优化后核函数执行时间

一个线程采样一次的的结果如上。

可以直接查看提交结果，其中sec2_base为一个线程多次采样未优化版本的输出，sec2_opt为优化后输出。sec2_sbase为一个线程采样1次未优化版本的输出，sec2_sopt为其优化后输出。采用一个线程多次采样的采样方式最终前100个节点采样结果如下

```
0 34308
1 27024
2 43023
3 54030
4 39644
5 31130
6 57252
7 43606
8 29800
9 42712
10 34803
11 34162
12 56015
13 43090
14 37084
15 46958
16 41483
17 33672
18 93376
19 32758
20 61525
21 30441
22 37383
23 33963
24 49831
25 31357
26 42964
27 46744
28 45144
29 31728
30 48798
31 46060
32 59779
33 32565
34 46076
35 52296
36 30045
37 52080
38 31551
39 43638
40 56339
41 33463
42 43163
43 39293
44 36882
45 47629
46 58128
47 37379
48 37314
49 42817
50 30845
51 55083
52 28618
53 37378
54 28192
55 40838
56 56647
57 41019
58 38264
59 50161
60 38947
61 51770
62 34610
63 48204
64 40509
65 42207
66 34152
67 38950
68 45043
69 69752
70 35815
71 56745
72 51247
73 36563
74 36621
75 43908
76 36236
77 34291
78 37844
79 40965
80 31500
81 44517
82 29971
83 42459
84 31426
85 33227
86 49868
87 42980
88 32738
89 52243
90 42132
91 47500
92 50947
93 37154
94 41483
95 38486
96 32664
97 45980
98 33549
99 40747
```



